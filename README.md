# Netflix

## 1. Выбор темы и целевой аудитории
#### Тема - Netflix для российской аудитории. 
Назначение сервиса - предоставить пользователю стандартные возможности стримингового видеосервиса: просмотр кино, сериалов и краткой информации о контенте, наличие подборок, а конкретно реализованы такие разделы как ‘сериалы’, ‘фильмы’, ‘последнее’, ‘бесплатное’, удобная навигация по контенту с фильтрами, возможность осуществлять поиск, оформление подписки, настройка личного кабинета.

#### Целевая аудитория - 3 млн. человек
Исходя из [данных](https://vc.ru/media/205039-kinopoisk-hd-rasskazal-o-rekordnyh-3-mln-smotryashchih-podpischikov-v-yanvare) о главных конкуретнах онлайн-кинотеатров на рынке России аудитория пользователей Netflix составит 3 млн. человек.

  [Анализ показателей Netflix в России](https://pro.similarweb.com/#/companyresearch/websiteanalysis/overview/website-performance/netflix.com/*/643/2020.01-2020.03?webSource=Total)

## 2. Расчет нагрузки

### Сетевой трафик на загрузку видео

|Параметр|Значение|Ссылка на источник|
| - | - | - |
|Аудитория|3 146 000|[pro.similarweb.com](https://pro.similarweb.com/#/companyresearch/websiteanalysis/overview/website-performance/netflix.com/*/643/2020.01-2020.03?webSource=Total)[vc.ru](https://vc.ru/media/205039-kinopoisk-hd-rasskazal-o-rekordnyh-3-mln-smotryashchih-podpischikov-v-yanvare)|
|Количество посетителей в сутки|1 000 000|[forbes.ru](https://www.forbes.ru/tehnologii/419761-my-otstaem-ot-netflix-na-gody-onlayn-kinoteatry-pozhalovalis-na-zaregulirovannost)|
|Время просмотра контента в сутки (в среднем)|3,2 часа|[pcmag.com](https://www.pcmag.com/news/us-netflix-subscribers-watch-32-hours-and-use-96-gb-of-data-per-day)|
|Используемые данные подписчиком в сутки (в среднем)|9,6 Гб||
|Примерное пиковое время и количество пользователей |с 8 до 10 вечера - 50% аудитории за день|[qz.com](https://qz.com/india/989659/netflix-nflx-peak-viewing-hours-are-very-different-in-india-and-argentina-compared-to-the-us-and-europe/#:~:text=Netflix's%20subscribers%20are%20setting%20their,by%20Netflix%E2%80%94the%20US%20included.)|
|Количество просматриваемых страниц в среднем|3,8|[pro.similarweb.com](https://pro.similarweb.com/#/companyresearch/websiteanalysis/overview/website-performance/netflix.com/*/643/2020.01-2020.03?webSource=Total)|
|Просмотр с ноутбука|85,58%||
|Просмотр с мобильного приложения|14,42%||

#### Соотношение использования памяти и качества контента (десктоп)
| Качество | Трафик |
| - | - |
|Low|0,3 Гб/час - 0.083 Мб/сек|
|Medium|0,7 Гб/час - 0.194 Мб/сек|
|Hight|3 Гб/час -  0.833 Мб/сек|
|HD quality|4.2 Гб/час - 1.167 Мб/сек|
|Ultra HD quality|7 Гб/час - 1.944 Мб/сек|

Источник: [help.netflix.com](https://help.netflix.com/en/node/87#:~:text=Watching%20TV%20shows%20or%20movies,each%20stream%20of%20HD%20video.)


#### Средняя скорость в России на 2021

||Десктоп|Мобильный|
| :- | - | - |
|Москва|81.94 Мбит/сек|23.64 Мбит/сек|
|Остальные региона (0.66(6) \* Москва)|54.63 Мбит/сек|15.76 Мбит/сек|

Источник: [speedtest.ne ](https://www.speedtest.net/global-index/russia)[m24.ru](https://www.m24.ru/news/tehnologii/28122020/147468)


Сделаем предположение о распределении аудитории по стране и использования качества контента:

||Десктоп (85.58%)|Мобильный (14.42%)|
| :- | - | - |
|Москва (40%) - 400 000 -> 1 280 000 часов/сутки|Ultra HD - 20% HD - 30% Hight - 20% Medium - 20 % Low - 10%|HD - 20% Hight - 30% Medium - 30 % Low - 20%|
|Регионы (60%) - 600 000 -> 1 920 000 часа/сутки|Ultra HD - 10% HD - 30% Hight - 30% Medium - 20 % Low - 10%|Hight - 30% Medium - 40 % Low - 30%|

Тогда расчетная нагрузка:
||Десктоп|Мобильный|
| :- | - | - |
|Москва|1 280 000 \* 0.8558 \* (0.2 \* 7 + 0.3 \*4.2 + 0.2 \* 3 + 0.2 \* 0,7 + 0.1 \* 0.3) = 3 757 304, 32 Гб|1 280 000 \* 0.1442 \* (0.2 \* 4.2 + 0.3 \* 3+ 0.3 \* 0,7 + 0.2 \* 0.3) = 370 997, 76 Гб|
|Регионы|1 920 000 \* 0.8558 \* (0.1 \* 7 + 0.3 \*4.2 + 0.3 \* 3 + 0.2 \* 0,7 + 0.1 \* 0.3) = 4 978 702, 08 Гб|1 920 000 \* 0.1442 \* (0.3 \* 3 + 0.4 \* 0,7 +0.3 \* 0.3) = 351 617, 28 Гб|

#### Итог: примерно 9 458 621, 44 Гб в день или 9 458, 62 Тб

Найдем примерное количество пользователей онлайн в среднем:
  1 000 000 * 3,2 / 24 = 133 334 пользователей
 
#### Средний трафик 9,46 * 1 000 000 / (24 * 60 * 60) = 109,5 Гб/сек = 876 Гбит/сек

Предположим, что в пиковое время может быть онлайн 500 000:

#### Пиковый трафик 9,48 * 500 000 / (2 * 60 * 60) = 658 Гб/сек = 5264 Гбит/сек

### Загрузка приложения
Исходя из [анализа загрузки страницы Netflix](https://gtmetrix.com/reports/www.netflix.com/sRz0KiJW/):
3,1 МБ * 1 000 000 = 3 100 000 Гб в день

### Сетевой трафик
При использовании сервиса 1,5 минуты (только бизнес логика, без просмотра видео):

Статика - 6,5 МБ (22 запросов); 
Динамика - 190 МБ (642 запросов); 
Изображения - 24.3 МБ (906 запросов)

Пусть один пользователь тратит только на посещение страниц сервиса 30 минут в среднем в день, тогда трафик:

```
Трафик в день:
Статика: (6,5 / 1,5) * 30 * 1 000 000 = 130 000 Гб/сутки
Динамика: (190 / 1,5) * 30 * 1 000 000 = 3 800 000 Гб/сутки
Изображения: (24.3 / 1,5) * 30 * 1 000 000 = 486 000 Гб/сутки

Трафик во время пиковой нагрузки (в Гб/сек):
Статика: 6,5 / (1,5 * 60) * 500 000 = 324,9 Гб/сутки
Динамика: 190 / (1,5 * 60) * 500 000 = 9 500 Гб/сутки
Изображения: 24.3 / (1,5 * 60) * 500 000 = 1 215 Гб/сутки
```

### Запросы

Среднее количество запросов в секунду на основе вышеприведенных данных пользования сервисом:
```
(22 + 642 + 906) / (1,5 * 60) * 1 000 000 / (24 * 60 * 60) = 201 rps
```

Общее количество запросов в секунду в пиковое время (одновременно находится 500 000 человек):
```
(22 + 642 + 906) / (1,5 * 60) * 500 000 / (2 * 60 * 60) = 1 211 rps
```

  Произведем расчет rps по основным типам запросов, выделив их на основе бизнес-логики и предположив приблизительно сколько раз в день в среднем один пользователь делает какие запросы. В сервисе-аналоге произведем выделенные типы запросов, с помощью инструментов разработчика узнаем количество сделанных запросов к сервису и поделим на время выполнения запроса.

| Запрос | Количество | Тип запроса | Расчет |
| - | - | - | - |
| Страница с контентом (главная, фильмы, сериалы, популярное) | 3 | чтение | 3 * 1 000 000 / (24 * 60 * 60) = 34,7 rps |
| Профиль | 1 | чтение | 1 000 000 / (24 * 60 * 60) = 11,6 rps |
| Отдельный фильм/сериал (информация) | 5 | чтение | 5 * 1 000 000 / (24 * 60 * 60) = 57,9 rps |
| Плеер | 2 | чтение | 2 * 1 000 000 / (24 * 60 * 60) = 23,2 rps |
| Лайк/Дизлайк | 5 | запись | 1 * 5 * 1 000 000 / (24 * 60 * 60) = 57,8 rps |
| Избранное | 2 | чтение | 2 * 1 000 000 / (24 * 60 * 60) = 63,6 rps |
| Добавление в избранное | 3 | запись | 3 * 1 000 000 / (24 * 60 * 60) = 34,7 rps |
| Поиск | 4 | чтение | 4 * 1 000 000 / (24 * 60 * 60) = 46,3 rps |

### Объем видео
На нетфликсе [содержится](https://www.whats-on-netflix.com/news/how-long-would-it-take-to-watch-all-of-netflix/) контента на 36 000 часов - 5817 позиций (фильмов и сериалов). Сервис будет хранить исходники сериалов и фильмов. Пусть 40% контента занимают фильм, остальные 60% сериалы.

Битрейтр оригинального видео - [1.4 Гбит/сек](https://ru.wikipedia.org/wiki/%D0%91%D0%B8%D1%82%D1%80%D0%B5%D0%B9%D1%82)
Тогда один час оригинального видео весит:
(1400 / 8) * (60 * 60) = 0,63 Тбайт

#### Тогда 36 000 часов весят : 36 000 * 0,63 = 22 680 Тб

Многовесовой оригинал фильма/серии не раздается пользователям, сначала он сжимается - например, форматом H.265 или HEVC - далее распределенно хранится по различным серверам, и только по запросу контент отдается по протоколам стриминга MPEG DASH или HLS.

Большинство контента на Нетфликсе [имеет framerate 24 кадра](https://www.howtogeek.com/338983/how-much-data-does-netflix-use/#:~:text=Most%20videos%20you%20play%20on,or%2059.940%20frames%20per%20second) в секунду, но также имеет место и framerate в 60 кадров в секунду.

Возьмем среднюю длительность контента - (фильмы 1,5 -2 часа и серии в сериалах 0,5 - 1час) - 1 час и рассчитаем для framerates и соответствующих quality (https://ru.tab-tv.com/?page\_id=161) видео их вес - (с помощью калькулятора [https://toolstud.io/video/filesize.php)](https://toolstud.io/video/filesize.php)

Качество **SD (480p)**

|Разрешение|Размер (частота кадров - 24)|Размер (частота кадров - 60)|
| - | - | - |
|720×480|583.19 МБ|1.46 ГБ|
|704×480|570.23 МБ|1.43 ГБ|
|352×480|285.12 МБ|712.79 МБ|
|720×576|699.83 МБ|1.75 ГБ|
|704×576|684.28 МБ|1.71 ГБ|
|352×576|342.14 МБ|855.35 МБ|
|640x480|518.39 МБ|1.3 ГБ|
|640x240|259.2 МБ|647.99 МБ|


Качество **HD**

|Разрешение|Размер (частота кадров - 24)|Размер (частота кадров - 60)|
| - | - | - |
|960×720|1.17 ГБ|2.92 ГБ|
|1440×720|1.75 ГБ|4.37 ГБ|
|2560x1440|2.71 ГБ|15.55 ГБ|


Качество **Full HD (1080p)**

|Разрешение|Размер (частота кадров - 24)|Размер (частота кадров - 60)|
| - | - | - |
|1920x1080|2.51 ГБ|6.26 ГБ|
|1440x1080|1.88 ГБ|4.7 ГБ|
|2160x1080|2.82 ГБ|7.05 ГБ|
|2560x1080|3.34 ГБ|8.35 ГБ|
|1728×1080|2.25 ГБ|5.64 ГБ|


Качество **Ultra HD**

|Разрешение|Размер (частота кадров - 24)|Размер (частота кадров - 60)|
| - | - | - |
|3840x2160|6.74 ГБ|16.85 ГБ|
|4096x2160|7.19 ГБ|17.97 ГБ|
|4096x1716|5.71 ГБ|14.28 ГБ|


#### Итого: Одно видео занимает ~155,81 Гб

36 000 часов \* 155,81 Гб = 5 609 160 Гб = 5 609,160 ТБ

Источники: [medium.com](https://medium.com/@narengowda/netflix-system-design-dbec30fede8d), [thecode.media](https://thecode.media/zapusk-kino/#tekst3),[habr.com](https://habr.com/ru/post/409583/)


## 3. Логическая схема

![image](https://user-images.githubusercontent.com/60325113/118377793-2d269a00-b5d8-11eb-800b-58601be272c2.png)

## 4. Физическая схема

![image](https://user-images.githubusercontent.com/60325113/119121437-16e46800-ba36-11eb-9dfd-376147d555c0.png)

#### Архитектура
  Архитектура будет монолитной, так как нагрузка на бизнес-логику и базу данных небольшая, cами видео фильмов и серий будут храниться отдельно на CDN серверах. Запросы за бизнес логикой будут обрабатываться единым бекендом, запросы за видео проксируются на сервер geo-based-dns. В качестве базы данных будем использовать PostgreSQL, так как она является одной из самых надежных баз данных с обширным удобным функционалом для управления большим объемом данных.  Для хранения аналитических данных будет использоваться ClickHouse. Связи между сервисами можно увидеть на схеме:
![image](https://user-images.githubusercontent.com/60325113/119115284-af2b1e80-ba2f-11eb-9c8d-2e781c4fc31b.png)

#### Расчет таблиц баз данных
Примерный расчет таблиц

```
Content: 
(id) 4 + (name) 128 + (original_name) 128
+ (description - avg) 1024 +
(short_description - avg) 512 + (rating) 4 +
(year)2 + (images)128 + (content_type)4 +
(boolean)1 = 1935 б -> 5817 * 1935 = 11 255 895 б = 0,011 Гб

Movies:
(id) 4 + (video) 128 + (content_id) 4 = 136 б
-> 2326,8 * 136 = 316 444 б = 0,00032 Гб
`
Tv_shows:
(id) 4 + (seasons) 4 + (content_id) 4 = 12 б
-> 3490,2 * 12 = 41 882 б

Seasons:
(id) 4 + (number) 4 + (episodes) 4 +
(tv_show_id) 4 = 16 б -> 30 000 * 3 * 16 = 1 440 000 б = 0,0014 Гб

Episodes:
(id) 4 + (number) 4 + (name) 128 + (video)
128 + (description - avg) 256 + (poster)
128 + (season_id) 4 = 16 б -> 30 000 * 10 *
16 = 4 800 000 б = 0,0048 Гб

Content_genre:
(content_id) 4 + (genre_id) 4 = 8 б -> 30 000 * 2 * 8 = 480 000 б

Genres:
(id) 4 + (name) 64 = 68 б -> 40 * 68 = 2 720 б

Content_actor:
(content_id) 4 + (actor_id) 4= 8 б -> 30 000
* 15 * 8 = 3 600 000 б  = 0,0036 Гб

Actors:
(id) 4 + (name) 64 = 68 б -> 300 000 * 68 = 20 400 000 б = 0,02 Гб

Content_country:
(content_id) 4 + (country_id) 4 = 8 б -> 30
000 * 2 * 8 = 480 000 б  = 0,00048 Гб

Countries:
(id) 4 + (name) 64 = 68 б -> 120 * 68 = 8 160 б

Content_director: 
(content_id) 4 + (director_id) 4 = 8 б -> 30
000 * 1 * 8 = 240 000 б = 0,00024 Гб

Directors:
(id) 4 + (name) 64 = 68 б -> 3000 * 68 = 204 000 б = 0,000204 Гб

Users:
(id) 4 + (nickname) 64 + (email) 64 +
(password) 128 + (avatar) 64 + (role) 4 =
328 б -> 3 146 000 * 328 = 1 031 888 000 б = 1,032 Гб

Rates:
(user_id) 4 + (content_id) 4 + (likes) 1 = 9 б
-> 10 000 000 * 9 = 90 000 000 б = 0,09 Гб

Subscriptions:
(id) 4 + (owner) 4 + (expires) 8 + (is_paid) 1
+ (is_canceled) 1 = 18 б ->3 146 000 * 18 =
56 628 000 б = 0,057 Гб

Sessions:
(id) 4 + (value) 64 + (expires) 8 + (user_id)
4 = 80 б -> 3 146 000 * 80 = 251 680 000 б = 0,252 Гб

Favourites:
 (user_id) 4 + (content_id) 4 + (created) 8 =
16 б -> 10 000 000 * 16 = 160 000 000 б = 0,16 Гб


База данных управления контентом: 0,038 Гб
База данных авторизации: 1,284 Гб
Пользовательские данны: примерно 1 Гб

```

#### Шардирование и репликация

Так как базы данных серверов особо не являются нагруженными, а пользовательские запросы по бизнес-логике составляют малую часть от ежедневного трафика, таблицы нет смысла шардировать. Основная нагрузка придется на просмотр видео, это будет описано далее.

Для надежности и разгрузки серверов будем использовать репликацию, для каждого сервера-мастера будет создаваться две реплики-слейва. Для обеспечения отказоустойчивости, при поломке местера можно переключиться на слейв и наоборот. Мастер будет принимать запросы на запись, реплики - на чтение.

#### Контент и CDN сервера

Как уже было сказано выше, контент будет храниться на CDN серверах. Расположить их стоит преимущественно в
западной части страны - Москве, Питере, городах-миллионниках, а также на Дальнем
Востоке и т. д., ориентироваться можно по [данным о самых населенных городах России](http://www.statdata.ru/goroda-millionniki-rossii-po-naseleniu).

Примерное расположение CDN-серверов:
![image](https://user-images.githubusercontent.com/60325113/119111840-2199ff80-ba2c-11eb-9f43-5d7d8e38868d.png)

На основе статистики о популярном контенте будут выделяться мелкие CDN, на
которых будут располагаться закэшированные наиболеепопулярные фильмы и
сериалы. Пусть данные о популярном контенте будут обновляться раз в сутки. Возможно
даже объединение мелких CDN в кластеры - тогда кэшированный популярный контент
будет распределяться по кластеру. Также можно объединять в кластеры и большие CDN
сервера - на них будет храниться весь видеоконтент сервиса. Кластеры CDN
располагаются у ISP (провайдеры интернета) или в IXP(точки обмена трафиком).

```
Тогда конфигурация CDN сервера будет:
Процессор: Intel Gold 6240R (24x2.4 ГГц HT)
Оперативная память: 512 Гб
Сеть: 
  * крупные - 2 сетевые карты по 25 Гбит/сек
  * мелкие - 2 сетевые карты по 50 Гбит/сек
Количество: 
  * крупные - 0,4 * 5264 Гбит/сек / (25 * 2) = 43
  * мелкие - 0,6 * 5264 Гбит/сек / (50 * 2) = 32
  
  полученное количество CDN будет распределено по наиболее крупным городам России.
  
SSD:
  * Мелкие CDN с популярным контентом (пусть это будет 5% = 0.05 * 5 609,160 ТБ = 280,45 Тб):
 
так как популярный контент занимает большую часть трафика и является самой нагруженной частью,
в каждом мелком CDN будет храниться копия всего популярного контента, для этого нужно для одного сервера 
выделить 20 SSD по 20 Тб, для надежности сделать по две реплики на каждый мелкий CDN.

  * Большие CDN, хранящие остальной видео контент:

будем хранить весь основной контент в каждой точке, так как он занимает 5 609,16 Тб можно ставить 
несколько CDN в одном узле, объединяя их в кластеры, например, по 10 CDN-серверов - по 560 Тб 
(выделить 20 SSD по 30 Тб) и сделать по одной реплике на каждый крупный CDN.

Оригиналы видео храним отдельно, не на CDN, а на отдельных серверах.
22 680 Тб распределим по 23м серверам - их можно хранить на HDD, объединенных в RAID массивы
```

#### Маршрутизация запросов
Запросы на стриминг видео будут распределяться [Geo based dns](https://docs.microsoft.com/ru-ru/windows-server/networking/dns/deploy/primary-geo-location). 
Когда пользователь делает запрос за видео - он идет на DNS-балансировщик, который может оценить расположение клиента, подобрать самый ближайший к нему CDN-сервер и далее отдавать видео с него.

## 4. Выбор технологий

Фронтенд: react, как одна из самых удобных современных библиотек для разработки пользовательских интерфейсов + mobx, как хорошо подходящая для react библиотека управления состоянием приложения + typescript, для предотвращения ошибок на этапе компиляции проекта + webpack, как универсальный и удобный сборщик модулей приложения.

Бекенд: go, так как он удобен для написания микросервисов (взаимодейтсвие можно осуществлять по протоколу grpc), имеет возможность благодаря горутинам эффективно реализовывать параллелизм.

Раздача статики: nginx, универсальный и надежный статик-сервер

Взаимодействие между клиентом и фронтендом, фронтендом и бекендом по HTTP2

## 4. Схема проекта


#### Выбор оборудования

| | CPU | RAM(Гб) | SSD | Количество | Расположение |
| - | - | - | - | - | - |
| Фронтенд | 8 | 64 | 128 Гб |  10 +5 | Москва и Санкт-Петербург |
| NGINX | 32 | 128 | 256 Гб | 20 + 10 | Москва и Санкт-Петербург |
| Бэкенд | 64 | 256 | 512 Гб | 10 + 5 | Москва и Санкт-Петербург |
| Сервис аналитики | 32 | 128 | 256 Гб | 4 + 2 | Москва и Санкт-Петербург |
| Сервис рекомендаций | 32 | 128 | 256 Гб | 4 + 2 | Москва и Санкт-Петербург |
| Мелкие CDN с популярным контентом | 8 | 512 | 20 * 30 Тб | 32 * 10 * 3 = 96 | 50 % - Москва и Санкт-Петербург, 50 % - остальные крупные города России |
| Крупные CDN | 8 | 512 | 20 * 20 Тб | 43 * 2 = 110 | 50 % - Москва и Санкт-Петербург 50 % - остальные крупные города России |

#### Схема

![image](https://user-images.githubusercontent.com/60325113/119115503-e4d00780-ba2f-11eb-874a-1f0ca3c9bd6d.png)


